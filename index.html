<!DOCTYPE html>
<html>
<head>
  <title>Elevator Simulation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }
    .instructions {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    }
    .lifter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: center;
      margin: 20px;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .lifter {
      position: relative;
      width: 100px;
      height: 320px;
      background-color: #555;
      border-radius: 10px;
      border: 2px solid #333;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .platform {
      position: absolute;
      bottom: 60px;
      left: -10px;
      width: 120px;
      height: 25px;
      background-color: #999;
      border-radius: 5px;
      transition: bottom 0.5s ease-in-out;
      border: 1px solid #666;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .base {
      position: absolute;
      bottom: 0;
      left: -5px;
      width: 110px;
      height: 45px;
      background-color: #333;
      border-radius: 10px;
      border: 1px solid #222;
    }
    .person {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      transition: all 0.8s ease-in-out;
      border: 1px solid rgba(0,0,0,0.3);
    }
    .person.waiting {
      bottom: 20px;
      opacity: 1;
    }
    .person.in-lifter {
      position: relative;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
      transform: translateZ(0);
      display: inline-block;
      margin: 2px;
      opacity: 1;
    }
    .person.deboarding {
      opacity: 0;
      transform: scale(0.5);
    }
    .person.boarding {
      opacity: 0.7;
      transform: scale(1.2);
    }
    .lifter-passengers {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
    }
    .lifter {
      z-index: 1;
      overflow: visible;
      position: relative;
      transform-style: preserve-3d;
    }
    .platform {
      z-index: 2;
    }
    .floor-stats {
      position: absolute;
      right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
    .floor-line {
      position: absolute;
      left: 20px;
      right: 20px;
      height: 3px;
      background-color: #555;
      z-index: 0;
      border-radius: 2px;
    }
    .floor-label {
      position: absolute;
      left: 30px;
      font-size: 16px;
      font-weight: bold;
      background: rgba(255,255,255,0.9);
      padding: 0 5px;
      border-radius: 3px;
    }
    .controls {
      text-align: center;
      margin: 20px;
    }
    .controls button {
      padding: 12px 25px;
      margin: 5px 10px;
      font-size: 16px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    .controls button:hover {
      background-color: #45a049;
    }
    .controls button#resetBtn {
      background-color: #f44336;
    }
    .controls button#resetBtn:hover {
      background-color: #da190b;
    }
    .stats {
      margin: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .stats div {
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }
    .stats span {
      font-weight: normal;
      color: #555;
    }
    .lifter-stats {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 20px;
    }
    .lifter-stat {
      padding: 8px 15px;
      background: #fff;
      border-radius: 5px;
      font-size: 13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>Elevator Simulation</h1>
  <div class="instructions">
    Watch how elevators operate in a building with multiple floors. People (colored dots) appear on different floors and request to go to other floors. The color of each person indicates their destination floor. Click "Start Simulation" to begin and "Reset" to clear the simulation.
  </div>
  <div class="container">
    <div class="controls">
      <button id="startBtn">Start Simulation</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="stats">
      <div>People Waiting: <span id="waitingCount">0</span></div>
      <div>People Transported: <span id="transportedCount">0</span></div>
      <div>Average Wait Time: <span id="avgWaitTime">0</span>s</div>
    </div>
    <div class="lifter-stats" id="lifterStats"></div>

    <div class="floor-stats" style="top: 100px">
      Floor 1: <span id="floor1Stats">0 arrived, 0 departed</span>
    </div>
    <div class="floor-stats" style="top: 180px">
      Floor 2: <span id="floor2Stats">0 arrived, 0 departed</span>
    </div>
    <div class="floor-stats" style="top: 260px">
      Floor 3: <span id="floor3Stats">0 arrived, 0 departed</span>
    </div>

    <div class="floor-line" style="bottom: 80px;"></div>
    <div class="floor-label" style="bottom: 85px; color: hsl(0, 70%, 60%);">Floor 1</div>
    <div class="floor-line" style="bottom: 160px;"></div>
    <div class="floor-label" style="bottom: 165px; color: hsl(120, 70%, 60%);">Floor 2</div>
    <div class="floor-line" style="bottom: 240px;"></div>
    <div class="floor-label" style="bottom: 245px; color: hsl(240, 70%, 60%);">Floor 3</div>

    <div class="floor-waiting" id="floor-waiting-1" style="position: absolute; bottom: 60px; right: 40px; width: 120px; height: 60px;"></div>
    <div class="floor-waiting" id="floor-waiting-2" style="position: absolute; bottom: 140px; right: 40px; width: 120px; height: 60px;"></div>
    <div class="floor-waiting" id="floor-waiting-3" style="position: absolute; bottom: 220px; right: 40px; width: 120px; height: 60px;"></div>

    <div class="lifter-container" id="lifterContainer"></div>
  </div>

  <script>
    // Configuration
    const NUM_LIFTERS = 3; // Reduced for more realistic building size
    const NUM_FLOORS = 3;
    const PERSON_SPAWN_RATE = 2000; // Slower spawn rate for realism (every 2 seconds)
    const TOTAL_PEOPLE = 100; // Reasonable number of people for simulation
    const FLOOR_TRAVEL_TIME = 2000; // Time to travel between floors in ms
    const DOOR_OPEN_TIME = 1500; // Time for doors to open and close
    const BOARDING_TIME = 500; // Time per person boarding/deboarding

    // State
    let lifters = [];
    let peopleWaiting = Array(NUM_FLOORS).fill().map(() => []);
    let peopleTransported = 0;
    let totalPeopleSpawned = 0;
    let totalWaitTime = 0;
    let simulationInterval;
    let spawnInterval;
    // Track arrivals from each origin floor to each destination floor
    let floorStats = Array(NUM_FLOORS).fill().map(() => ({
      arrivedFrom: Array(NUM_FLOORS).fill(0), // Count of people arrived from each floor
      departed: 0
    }));

    // Initialize lifters
    function initLifters() {
      const container = document.getElementById('lifterContainer');
      container.innerHTML = '';
      
      lifters = Array(NUM_LIFTERS).fill().map((_, i) => {
        const lifter = document.createElement('div');
        lifter.className = 'lifter';
        lifter.innerHTML = `
          <div class="platform" id="platform-${i}">
            <div class="lifter-passengers"></div>
          </div>
          <div class="base"></div>
        `;
        container.appendChild(lifter);
        
        return {
          id: i,
          element: document.getElementById(`platform-${i}`),
          passengersContainer: document.getElementById(`platform-${i}`).querySelector('.lifter-passengers'),
          currentFloor: 1,
          targetFloor: 1,
          direction: 0, // 0=idle, 1=up, -1=down
          passengers: [],
          callQueue: [], // Floors to visit
          maxCapacity: 8,
          state: 'idle', // idle, moving, doors_opening, boarding
          stateTimer: 0
        };
      });
    }

    // Floor positions
    const floorHeights = {
      1: 60,
      2: 140,
      3: 220
    };

    // Move lifter to floor
    function moveLifter(lifter, floor) {
      if (floor > lifter.currentFloor) {
        lifter.direction = 1;
      } else if (floor < lifter.currentFloor) {
        lifter.direction = -1;
      } else {
        lifter.direction = 0;
      }
      lifter.state = 'moving';
      lifter.targetFloor = floor;
      lifter.element.style.bottom = floorHeights[floor] + 'px';
      
      // Calculate travel time based on number of floors
      const floorsToTravel = Math.abs(floor - lifter.currentFloor);
      const travelTime = floorsToTravel * FLOOR_TRAVEL_TIME;
      
      lifter.stateTimer = setTimeout(() => {
        lifter.currentFloor = floor;
        lifter.state = 'doors_opening';
        lifter.stateTimer = setTimeout(() => {
          lifter.state = 'boarding';
          processBoarding(lifter);
        }, DOOR_OPEN_TIME);
      }, travelTime);
    }

    // Handle boarding and deboarding with animations
    function processBoarding(lifter) {
      // First deboard passengers for current floor
      const deboarding = lifter.passengers.filter(p => p.destinationFloor === lifter.currentFloor);
      let deboardIndex = 0;
      let boardIndex = 0;
      const floorQueue = peopleWaiting[lifter.currentFloor - 1];
      const boarding = [];

      // Prepare boarding list
      while (floorQueue.length > 0 && lifter.passengers.length < lifter.maxCapacity) {
        const person = floorQueue.shift();
        const personDirection = person.destinationFloor > lifter.currentFloor ? 1 : -1;
        if (lifter.direction === 0 || lifter.direction === personDirection || lifter.callQueue.length === 0) {
          boarding.push(person);
          if (lifter.direction === 0) {
            lifter.direction = personDirection;
          }
        } else {
          floorQueue.push(person);
          break;
        }
      }

      // Function to handle deboarding animation one by one
      function animateDeboarding() {
        if (deboardIndex < deboarding.length) {
          const p = deboarding[deboardIndex];
          const waitTime = Date.now() - p.waitStart;
          totalWaitTime += waitTime;
          p.element.classList.add('deboarding');
          setTimeout(() => {
            p.element.classList.remove('deboarding');
            p.element.style.position = 'absolute';
            const floorWaitingArea = document.getElementById(`floor-waiting-${p.destinationFloor}`);
            floorWaitingArea.appendChild(p.element);
            const index = floorWaitingArea.childElementCount - 1;
            const row = Math.floor(index / 6);
            const col = index % 6;
            p.element.style.left = `${10 + col * 18}px`;
            p.element.style.bottom = `${10 + row * 18}px`;
            setTimeout(() => p.element.remove(), 1500);
            peopleTransported++;
            floorStats[p.destinationFloor - 1].arrivedFrom[p.startFloor - 1]++;
            updateStats();
            updateFloorStats();
            deboardIndex++;
            animateDeboarding();
          }, 800);
        } else {
          lifter.passengers = lifter.passengers.filter(p => p.destinationFloor !== lifter.currentFloor);
          updatePassengerPositions(lifter);
          animateBoarding();
        }
      }

      // Function to handle boarding animation one by one
      function animateBoarding() {
        if (boardIndex < boarding.length) {
          const person = boarding[boardIndex];
          person.element.classList.add('boarding');
          setTimeout(() => {
            person.element.classList.remove('boarding');
            person.boardLifter(lifter);
            boardIndex++;
            animateBoarding();
          }, 800);
        } else {
          lifter.state = 'idle';
          determineNextAction(lifter);
        }
      }

      // Start the animation sequence
      if (deboarding.length > 0) {
        animateDeboarding();
      } else if (boarding.length > 0) {
        animateBoarding();
      } else {
        lifter.stateTimer = setTimeout(() => {
          lifter.state = 'idle';
          determineNextAction(lifter);
        }, DOOR_OPEN_TIME);
      }
    }

    // Determine next action for elevator
    function determineNextAction(lifter) {
      // Clear any existing timer
      if (lifter.stateTimer) {
        clearTimeout(lifter.stateTimer);
        lifter.stateTimer = 0;
      }
      
      // If there are passengers, go to their destinations
      if (lifter.passengers.length > 0) {
        // Group destinations by floor
        const destinations = [...new Set(lifter.passengers.map(p => p.destinationFloor))];
        // Sort based on current direction
        if (lifter.direction === 1) {
          destinations.sort((a, b) => a - b);
        } else if (lifter.direction === -1) {
          destinations.sort((a, b) => b - a);
        } else {
          // If no direction, choose closest
          destinations.sort((a, b) => Math.abs(a - lifter.currentFloor) - Math.abs(b - lifter.currentFloor));
          lifter.direction = destinations[0] > lifter.currentFloor ? 1 : -1;
        }
        lifter.callQueue = destinations;
        moveLifter(lifter, destinations[0]);
        return;
      }
      
      // Check call queue
      if (lifter.callQueue.length > 0) {
        const nextFloor = lifter.callQueue.shift();
        moveLifter(lifter, nextFloor);
        return;
      }
      
      // No passengers, no calls - look for waiting people
      const floorsWithWaiting = [];
      for (let i = 0; i < NUM_FLOORS; i++) {
        if (peopleWaiting[i].length > 0) {
          floorsWithWaiting.push({
            floor: i + 1,
            count: peopleWaiting[i].length,
            distance: Math.abs((i + 1) - lifter.currentFloor),
            waitTime: peopleWaiting[i].length > 0 ? Date.now() - peopleWaiting[i][0].waitStart : 0
          });
        }
      }
      
      if (floorsWithWaiting.length > 0) {
        // Sort by a combination of wait time and distance
        floorsWithWaiting.sort((a, b) => (b.waitTime * 0.6 + b.count * 0.4) - (a.waitTime * 0.6 + a.count * 0.4));
        const targetFloor = floorsWithWaiting[0].floor;
        lifter.callQueue = [targetFloor];
        moveLifter(lifter, targetFloor);
        return;
      }
      
      // If nothing to do, return to ground floor or stay put
      lifter.direction = 0;
      if (lifter.currentFloor !== 1) {
        moveLifter(lifter, 1);
      }
    }

    // Person class
    class Person {
      constructor() {
        this.startFloor = Math.floor(Math.random() * NUM_FLOORS) + 1;
        let destinationFloor = this.startFloor;
        while (destinationFloor === this.startFloor) {
          destinationFloor = Math.floor(Math.random() * NUM_FLOORS) + 1;
        }
        this.destinationFloor = destinationFloor;
        this.waitStart = Date.now();
        this.element = document.createElement('div');
        this.element.className = 'person waiting';
        // Set color based on destination floor
        const colors = {
          1: 'hsl(0, 70%, 60%)',   // Red for Floor 1
          2: 'hsl(120, 70%, 60%)', // Green for Floor 2
          3: 'hsl(240, 70%, 60%)'  // Blue for Floor 3
        };
        this.element.style.backgroundColor = colors[this.destinationFloor];
        this.element.style.zIndex = '100';
      }

      boardLifter(lifter) {
        this.element.classList.remove('waiting');
        this.element.classList.add('in-lifter');
        lifter.passengersContainer.appendChild(this.element);
        lifter.passengers.push(this);
        updatePassengerPositions(lifter);
      }
    }

    function updatePassengerPositions(lifter) {
      lifter.passengers.forEach((p, index) => {
        const row = Math.floor(index / 4);
        const col = index % 4;
        p.element.style.left = `${20 + col * 15}px`;
        p.element.style.bottom = `${20 + row * 20}px`;
        p.element.style.zIndex = 10 + row;
      });
    }

    // Spawn people
    function spawnPeople() {
      if (totalPeopleSpawned >= TOTAL_PEOPLE) {
        clearInterval(spawnInterval);
        return;
      }
      
      const person = new Person();
      peopleWaiting[person.startFloor - 1].push(person);
      // Add to the waiting area for the specific floor
      const floorWaitingArea = document.getElementById(`floor-waiting-${person.startFloor}`);
      floorWaitingArea.appendChild(person.element);
      // Position in grid layout within the waiting area
      const index = floorWaitingArea.childElementCount - 1;
      const row = Math.floor(index / 6); // Adjusted for better spacing
      const col = index % 6;
      person.element.style.left = `${10 + col * 18}px`; // Adjusted for better spacing
      person.element.style.bottom = `${10 + row * 18}px`; // Position relative to waiting area bottom
      floorStats[person.startFloor - 1].departed++;
      totalPeopleSpawned++;
      updateFloorStats();
      updateStats();
      updateLifterStats();
    }

    // Main simulation loop
    function runSimulation() {
      // Check on lifters that are idle and might need new actions
      lifters.forEach(lifter => {
        if (lifter.state === 'idle' && lifter.callQueue.length === 0 && lifter.passengers.length === 0) {
          determineNextAction(lifter);
        }
      });
    }

    // Update statistics
    function updateLifterStats() {
      const container = document.getElementById('lifterStats');
      container.innerHTML = '';
      
      lifters.forEach((lifter, i) => {
        const stat = document.createElement('div');
        stat.className = 'lifter-stat';
        const dir = lifter.direction === 1 ? '↑' : lifter.direction === -1 ? '↓' : '-';
        stat.textContent = `Lifter ${i+1}: Floor ${lifter.currentFloor}, Pass: ${lifter.passengers.length}/${lifter.maxCapacity}, Dir: ${dir}, State: ${lifter.state}`;
        container.appendChild(stat);
      });
    }

    function updateStats() {
      const totalWaiting = peopleWaiting.reduce((sum, queue) => sum + queue.length, 0);
      document.getElementById('waitingCount').textContent = totalWaiting;
      document.getElementById('transportedCount').textContent = peopleTransported;
      const avgWaitTime = peopleTransported > 0 ? (totalWaitTime / peopleTransported / 1000).toFixed(1) : 0;
      document.getElementById('avgWaitTime').textContent = avgWaitTime;
    }

    function updateFloorStats() {
      const colors = {
        1: 'hsl(0, 70%, 60%)',   // Red for Floor 1
        2: 'hsl(120, 70%, 60%)', // Green for Floor 2
        3: 'hsl(240, 70%, 60%)'  // Blue for Floor 3
      };
      
      for (let i = 0; i < NUM_FLOORS; i++) {
        const arrivedDetails = floorStats[i].arrivedFrom
          .map((count, originFloor) => {
            if (count > 0) {
              const floorNum = originFloor + 1;
              return `<span style="color: ${colors[floorNum]}">${count} from F${floorNum}</span>`;
            }
            return '';
          })
          .filter(text => text !== '')
          .join(', ');
          
        document.getElementById(`floor${i+1}Stats`).innerHTML = 
          `Arrived: ${arrivedDetails || '0'}, Departed: ${floorStats[i].departed}`;
      }
    }

    // Start simulation
    function startSimulation() {
      resetSimulation();
      spawnInterval = setInterval(spawnPeople, PERSON_SPAWN_RATE);
      simulationInterval = setInterval(runSimulation, 100);
    }

    // Reset simulation
    function resetSimulation() {
      clearInterval(simulationInterval);
      clearInterval(spawnInterval);
      lifters.forEach(lifter => {
        if (lifter.stateTimer) {
          clearTimeout(lifter.stateTimer);
        }
      });
      initLifters();
      peopleWaiting = Array(NUM_FLOORS).fill().map(() => []);
      peopleTransported = 0;
      totalPeopleSpawned = 0;
      totalWaitTime = 0;
      floorStats = Array(NUM_FLOORS).fill().map(() => ({
        arrivedFrom: Array(NUM_FLOORS).fill(0),
        departed: 0
      }));
      updateStats();
      updateFloorStats();
      updateLifterStats();
    }

    // Event listeners
    document.getElementById('startBtn').addEventListener('click', startSimulation);
    document.getElementById('resetBtn').addEventListener('click', resetSimulation);

    // Initialize
    initLifters();
  </script>
</body>
</html>
